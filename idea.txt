WITH LATEST_RUN_IDS AS (
    SELECT
          RESULT_RUN_ID
    FROM REPORTING.RODS_CALC_RUN_HISTORY_VW
    WHERE 
          CURRENT_TIMESTAMP BETWEEN TRANSACT_FROM_TS AND TRANSACT_TO_TS
      AND FREQUENCY = 'MONTHLY'
      AND CONSOLIDATION_GROUP = 'US_FHC_C'
      AND RESULT_SET_ID IN (26, 27, 28)
    QUALIFY 
          ROW_NUMBER() OVER (
              PARTITION BY RESULT_SET_ID, P_L_DATE, CONSOLIDATION_GROUP, FREQUENCY
              ORDER BY TRANSACT_FROM_TS DESC
          ) = 1
),
dataset AS (
    SELECT
          DATE_TRUNC('MONTH', P_L_DATE)       AS P_L_DATE,
          SACCR_ASSET_CLASS,
          PRODUCT_IDENTIFIER,
          SACCR_NETTING_SET,
          PARTY_ID,
          PARTY_NAME,
          COST_CENTER_L6,
          COST_CENTER_L7,
          COST_CENTER_L8,
          ALLOCATED_TRADE_RWA                 AS RWA,
          ALLOCATED_TRADE_EAD                 AS EAD,
          ALLOCATED_SLR                       AS SLR
    FROM REPORTING.SACCR_ALLOCATED_TRADE_EXPOSURE_REPORT_TB AS TBL
    WHERE EXISTS (
        SELECT 1
        FROM LATEST_RUN_IDS AS IDS
        WHERE TBL.RESULT_RUN_ID = IDS.RESULT_RUN_ID
    )
)
SELECT DISTINCT 
      'COST_CENTER_L7' AS dimension,
      COST_CENTER_L7   AS value
FROM dataset

UNION

SELECT DISTINCT 
      'COST_CENTER_L8' AS dimension,
      COST_CENTER_L8   AS value
FROM dataset;
